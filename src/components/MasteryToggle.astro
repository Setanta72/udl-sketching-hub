---
/**
 * Mastery Toggle Component
 * Allows users to switch between Novice, Proficient, and Mastery levels.
 * Dispatches 'udl:level-change' event and updates local storage.
 */
---

<div class="mastery-toggle-container">
  <div class="toggle-label">Learning Level:</div>
  <div class="toggle-wrapper">
    <button class="toggle-btn active" data-level="novice" aria-pressed="true">
      <span class="icon">ðŸŒ±</span>
      <span class="text">Novice</span>
    </button>
    <button class="toggle-btn" data-level="proficient" aria-pressed="false">
      <span class="icon">ðŸŒ¿</span>
      <span class="text">Proficient</span>
    </button>
    <button class="toggle-btn" data-level="mastery" aria-pressed="false">
      <span class="icon">ðŸŒ³</span>
      <span class="text">Mastery</span>
    </button>
    <div class="toggle-slider"></div>
  </div>
</div>

<script>
  // Initialize toggle logic
  function initToggle() {
    const buttons = document.querySelectorAll('.toggle-btn');
    const slider = document.querySelector('.toggle-slider') as HTMLElement;
    
    // Check local storage for saved preference
    const savedLevel = localStorage.getItem('udl-mastery-level') || 'novice';
    
    // Function to set level (UI only)
    const updateUI = (level: string) => {
      buttons.forEach(btn => {
        const isTarget = btn.getAttribute('data-level') === level;
        btn.classList.toggle('active', isTarget);
        btn.setAttribute('aria-pressed', isTarget.toString());
      });
      // Update global body attribute for CSS filtering
      document.body.setAttribute('data-current-level', level);
    };

    // Function to handle click and dispatch
    const handleLevelChange = (level: string) => {
      updateUI(level);
      localStorage.setItem('udl-mastery-level', level);
      
      // Dispatch event to sync other toggles
      window.dispatchEvent(new CustomEvent('udl:level-change', { 
        detail: { level } 
      }));
    };

    // Attach click listeners
    buttons.forEach(btn => {
      btn.addEventListener('click', () => {
        const level = btn.getAttribute('data-level');
        if (level) handleLevelChange(level);
      });
    });

    // Listen for updates from other toggles
    window.addEventListener('udl:level-change', (e: any) => {
      if (e.detail && e.detail.level) {
        updateUI(e.detail.level);
      }
    });

    // Set initial level
    updateUI(savedLevel);
  }

  // Run on load
  initToggle();
  
  // Re-run on view transitions if enabled
  document.addEventListener('astro:page-load', initToggle);
</script>

<style>
  .mastery-toggle-container {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-4);
    margin: var(--space-8) 0;
  }

  .toggle-label {
    font-weight: 700;
    color: var(--color-text-secondary);
    text-transform: uppercase;
    font-size: var(--text-sm);
    letter-spacing: 0.5px;
  }

  .toggle-wrapper {
    display: flex;
    background: var(--color-bg-secondary);
    padding: 4px;
    border-radius: 999px;
    border: 2px solid var(--color-border);
    position: relative;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
  }

  .toggle-btn {
    position: relative;
    z-index: 2;
    background: transparent;
    border: none;
    padding: var(--space-2) var(--space-6);
    border-radius: 999px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: var(--space-2);
    font-weight: 600;
    color: var(--color-text-secondary);
    transition: all 0.2s ease;
  }

  .toggle-btn:hover {
    color: var(--color-primary);
  }

  .toggle-btn.active {
    color: white;
    background: var(--color-primary);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }

  .icon {
    font-size: 1.2em;
  }

  /* Mobile responsiveness */
  @media (max-width: 640px) {
    .toggle-text {
      display: none;
    }
    .toggle-btn {
      padding: var(--space-2) var(--space-3);
    }
  }
</style>
