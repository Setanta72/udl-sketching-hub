---
/**
 * Concept Block Component v2.0
 * Self-contained learning block for ONE concept
 * Contains: Explanation ‚Üí Resources ‚Üí Gallery ‚Üí Drills ‚Üí Errors ‚Üí Tips
 * This is the fundamental unit of learning in the new architecture
 */

import { marked } from 'marked';
import ProgressionGallery from './ProgressionGallery.astro';
import DrillCard from './DrillCard.astro';
import ModesOfExpressionTabs from './ModesOfExpressionTabs.astro';

interface Props {
  concept: any; // Full concept object from content collections
  explanation?: string; // Markdown content for this concept
}

const { concept, explanation } = Astro.props;

// Process markdown to HTML if explanation exists
const explanationHtml = explanation ? marked.parse(explanation) : null;
---

<section class="concept-block" id={concept.id}>
  <!-- Concept Header -->
  <div class="concept-header">
    <div class="concept-number">Concept {concept.order}</div>
    <h3 class="concept-title">{concept.title}</h3>
  </div>

  <!-- Concept Explanation (from frontmatter) -->
  {explanationHtml && (
    <div class="concept-explanation">
      <div set:html={explanationHtml} />
    </div>
  )}

  <!-- Learning Resources -->
  {(concept.videoUrl || concept.pdfGuideUrl || concept.gallery) && (
    <div class="concept-resources">
      <h4 class="section-heading">Learning Resources</h4>
      <div class="resources-tabs">
        {concept.videoUrl && (
          <div class="resource-tab">
            <div class="resource-header">
              <span class="resource-icon">üé•</span>
              <h5>Video Tutorial</h5>
            </div>
            <div class="resource-content">
              <div class="video-wrapper">
                <p class="placeholder">Video: {concept.videoCaption || concept.title}</p>
                <p class="placeholder-note">Duration: {concept.videoDuration || 'Coming soon'}</p>
              </div>
            </div>
          </div>
        )}

        {concept.pdfGuideUrl && (
          <div class="resource-tab">
            <div class="resource-header">
              <span class="resource-icon">üìÑ</span>
              <h5>Step-by-Step Guide</h5>
            </div>
            <div class="resource-content">
              <p class="placeholder">{concept.pdfGuideTitle || 'PDF Guide'}</p>
              <a href={concept.pdfGuideUrl} class="download-button" target="_blank" rel="noopener">
                Download PDF
              </a>
            </div>
          </div>
        )}
      </div>
    </div>
  )}

  <!-- Progression Gallery -->
  {concept.gallery && (
    <ProgressionGallery
      novice={concept.gallery.novice}
      proficient={concept.gallery.proficient}
      mastery={concept.gallery.mastery}
    />
  )}

  <!-- Practice Drills -->
  {concept.drills && concept.drills.length > 0 && (
    <div class="concept-drills">
      <h4 class="section-heading">Practice Drills</h4>
      <p class="section-description">
        Work through these exercises to build your skills. Start with beginner drills and progress
        at your own pace. Pay attention to scaffolding suggestions - aids are tools that enable learning.
      </p>
      <div class="drills-grid">
        {concept.drills.map((drill: any) => (
          <DrillCard
            title={drill.title}
            description={drill.description}
            difficulty={drill.difficulty}
            scaffoldingSuggestion={drill.scaffoldingSuggestion}
            estimatedTime={drill.estimatedTime}
          />
        ))}
      </div>
    </div>
  )}

  <!-- Common Errors (Contextual!) -->
  {concept.commonErrors && concept.commonErrors.length > 0 && (
    <div class="concept-errors">
      <h4 class="section-heading">Common Errors & Solutions</h4>
      <p class="section-description">
        These are the most frequent mistakes learners make with this specific concept.
        If you're experiencing one of these issues, read the diagnosis and try the correction.
      </p>
      <div class="errors-list">
        {concept.commonErrors.map((error: any) => (
          <div class="error-card">
            <div class="error-header">
              <span class="error-icon">‚ö†Ô∏è</span>
              <h5 class="error-title">{error.errorTitle}</h5>
            </div>
            <p class="error-description">{error.description}</p>
            <div class="error-diagnosis">
              <strong>Diagnosis:</strong> {error.diagnosis}
            </div>
            <div class="error-correction">
              <strong>Correction:</strong> {error.correction}
            </div>
            {error.whenToUseAids && (
              <div class="error-aids-tip">
                <span class="aids-icon">üí°</span>
                <div>
                  <strong>Using Aids:</strong> {error.whenToUseAids}
                </div>
              </div>
            )}
          </div>
        ))}
      </div>
    </div>
  )}

  <!-- Physical vs Digital Tips -->
  {(concept.physicalTips || concept.digitalTips) && (
    <div class="concept-tips">
      <ModesOfExpressionTabs
        physical={concept.physicalTips}
        digital={concept.digitalTips}
      />
    </div>
  )}
</section>

<style>
  .concept-block {
    scroll-margin-top: 100px; /* For jump-to-concept navigation */
    margin: var(--space-20) 0;
    padding: var(--space-8);
    background: white;
    border-radius: var(--radius-xl);
    border: 3px solid var(--color-border);
    box-shadow: var(--shadow-lg);
  }

  .concept-header {
    margin-bottom: var(--space-8);
    border-bottom: 3px solid var(--color-secondary);
    padding-bottom: var(--space-4);
  }

  .concept-number {
    display: inline-block;
    background: var(--color-secondary);
    color: white;
    padding: var(--space-2) var(--space-4);
    border-radius: var(--radius);
    font-size: var(--text-sm);
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: var(--space-3);
  }

  .concept-title {
    font-size: var(--text-3xl);
    font-weight: 800;
    color: var(--color-primary);
    font-family: var(--font-heading);
    margin: 0;
  }

  .concept-explanation {
    margin-bottom: var(--space-10);
    line-height: var(--leading-relaxed);
    font-size: var(--text-lg);
  }

  .concept-explanation :global(p) {
    margin-bottom: var(--space-4);
    color: var(--color-text-secondary);
  }

  .concept-explanation :global(strong) {
    color: var(--color-primary);
    font-weight: 600;
  }

  .concept-explanation :global(em) {
    font-style: italic;
  }

  .concept-explanation :global(ul),
  .concept-explanation :global(ol) {
    margin: var(--space-4) 0;
    padding-left: var(--space-8);
    color: var(--color-text-secondary);
  }

  .concept-explanation :global(li) {
    margin-bottom: var(--space-2);
  }

  .concept-explanation :global(code) {
    background: var(--color-bg-tertiary);
    padding: var(--space-1) var(--space-2);
    border-radius: var(--radius-sm);
    font-family: 'Monaco', 'Courier New', monospace;
    font-size: var(--text-sm);
  }

  .section-heading {
    font-size: var(--text-2xl);
    font-weight: 700;
    color: var(--color-primary);
    margin-bottom: var(--space-4);
    font-family: var(--font-heading);
  }

  .section-description {
    color: var(--color-text-secondary);
    line-height: var(--leading-relaxed);
    margin-bottom: var(--space-6);
  }

  /* Resources */
  .concept-resources {
    margin: var(--space-10) 0;
  }

  .resources-tabs {
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
  }

  .resource-tab {
    background: var(--color-bg-secondary);
    border-radius: var(--radius-md);
    padding: var(--space-6);
    border: 2px solid var(--color-border);
  }

  .resource-header {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    margin-bottom: var(--space-4);
  }

  .resource-icon {
    font-size: var(--text-3xl);
  }

  .resource-header h5 {
    font-size: var(--text-xl);
    font-weight: 700;
    color: var(--color-primary);
    margin: 0;
  }

  .resource-content {
    padding-left: calc(var(--text-3xl) + var(--space-3));
  }

  .video-wrapper,
  .placeholder {
    padding: var(--space-8);
    background: var(--color-bg-tertiary);
    border-radius: var(--radius);
    text-align: center;
    color: var(--color-text-secondary);
  }

  .placeholder-note {
    margin-top: var(--space-2);
    font-size: var(--text-sm);
    color: var(--color-text-tertiary);
  }

  .download-button {
    display: inline-block;
    margin-top: var(--space-4);
    padding: var(--space-3) var(--space-6);
    background: var(--color-secondary);
    color: white;
    text-decoration: none;
    border-radius: var(--radius);
    font-weight: 600;
    transition: background var(--transition-base);
  }

  .download-button:hover {
    background: var(--color-secondary-dark);
  }

  /* Drills */
  .concept-drills {
    margin: var(--space-10) 0;
  }

  .drills-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: var(--space-6);
  }

  /* Errors */
  .concept-errors {
    margin: var(--space-10) 0;
  }

  .errors-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-6);
  }

  .error-card {
    background: var(--color-bg-secondary);
    border-left: 4px solid var(--color-warning);
    border-radius: var(--radius-md);
    padding: var(--space-6);
  }

  .error-header {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    margin-bottom: var(--space-4);
  }

  .error-icon {
    font-size: var(--text-2xl);
  }

  .error-title {
    font-size: var(--text-xl);
    font-weight: 700;
    color: var(--color-text-primary);
    margin: 0;
  }

  .error-description {
    margin-bottom: var(--space-4);
    line-height: var(--leading-relaxed);
    font-style: italic;
  }

  .error-diagnosis,
  .error-correction {
    margin-bottom: var(--space-3);
    line-height: var(--leading-relaxed);
  }

  .error-diagnosis strong {
    color: var(--color-warning);
  }

  .error-correction strong {
    color: var(--color-success);
  }

  .error-aids-tip {
    display: flex;
    gap: var(--space-3);
    margin-top: var(--space-4);
    padding: var(--space-4);
    background: var(--color-bg-accent);
    border-radius: var(--radius);
  }

  .aids-icon {
    font-size: var(--text-xl);
    flex-shrink: 0;
  }

  .error-aids-tip strong {
    color: var(--color-secondary-dark);
  }

  /* Tips */
  .concept-tips {
    margin: var(--space-10) 0;
  }
</style>
